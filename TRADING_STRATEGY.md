# 트레이딩 전략 시스템 문서

> 최종 업데이트: 2026-01-23
> 시스템: Tri-Strategy Trading System (CycleRider + HourSwing + BoxRange)

---

## 목차
1. [시스템 개요](#1-시스템-개요)
2. [매매 플로우](#2-매매-플로우)
3. [Strategy A: CycleRider](#3-strategy-a-cyclerider)
4. [Strategy B: HourSwing](#4-strategy-b-hourswing)
5. [Strategy C: BoxRange](#5-strategy-c-boxrange)
6. [공통 필터](#6-공통-필터)
7. [리스크 관리](#7-리스크-관리)

---

## 1. 시스템 개요

### 1.1 전략 구조
```
┌─────────────────────────────────────────────────────────────┐
│                    Tri-Strategy System                       │
├─────────────────┬─────────────────┬─────────────────────────┤
│   CycleRider    │    HourSwing    │       BoxRange          │
│   (추세 추종)    │   (단기 스윙)    │      (횡보장)           │
├─────────────────┼─────────────────┼─────────────────────────┤
│ - Accumulation  │ - MTF Alignment │ - Box 상/하단 반전      │
│ - Distribution  │ - Rel. Strength │ - SFP (Sweep) 감지      │
│ - Divergence    │ - Funding Extr. │ - Volume Profile        │
│ - Volume Climax │                 │                         │
│ - Squeeze       │                 │                         │
└─────────────────┴─────────────────┴─────────────────────────┘
```

### 1.2 모니터링 심볼
- **100개 심볼** (바이낸스 선물 거래량 상위)
- 자동 갱신 (서버 시작 시)

### 1.3 타임프레임
- 데이터 수집: `1m`, `5m`, `15m`, `1h`
- 시그널 스캔: 30분마다 (정시, 30분)
- 1분봉 진입: 매 1분마다 (활성 시그널만)

---

## 2. 매매 플로우

### 2.1 시그널 생성 플로우
```
[30분 스캔] ─────────────────────────────────────────────────────────────
     │
     ├─→ CycleRider 스캔 (100개 심볼)
     │      └─→ Volume Climax / Squeeze / Divergence 감지
     │
     ├─→ HourSwing 스캔 (100개 심볼)
     │      └─→ MTF Alignment / Funding Extremes 감지
     │
     └─→ BoxRange 스캔 (100개 심볼)
            └─→ Box 감지 → 활성 Box 캐시 저장
```

### 2.2 1분봉 진입 플로우
```
[1분봉 닫힘] ────────────────────────────────────────────────────────────
     │
     ├─→ 활성 Funding Extreme 체크
     │      └─→ 반전 구간 도달? → 주문 실행
     │
     └─→ 활성 Box 체크
            └─→ 진입 구간 도달? → 주문 실행
```

### 2.3 주문 실행 플로우
```
[시그널 발생] ───────────────────────────────────────────────────────────
     │
     ├─→ 리스크 체크 (일일 손실 한도, 최대 포지션 등)
     │
     ├─→ 진입 주문 (Market Order)
     │
     ├─→ SL/TP 주문 (Algo Order API)
     │      ├─→ SL: STOP 주문
     │      ├─→ TP1: TAKE_PROFIT 주문 (50%)
     │      └─→ TP2: TAKE_PROFIT 주문 (50%)
     │
     └─→ Position/Trade DB 저장 (주문 ID 포함)
```

### 2.4 체결 처리 플로우
```
[User Data Stream] ─────────────────────────────────────────────────────
     │
     ├─→ ORDER_TRADE_UPDATE 이벤트
     │      ├─→ LIMIT 주문 (reduceOnly=true) → Algo Order 트리거
     │      │      └─→ 가격 기반 SL/TP 매칭 (0.5% tolerance)
     │      │
     │      ├─→ STOP_MARKET / TAKE_PROFIT_MARKET → 직접 SL/TP
     │      │      └─→ 주문 ID 매칭 → close_reason 결정
     │      │
     │      └─→ realizedProfit (rp) 필드 사용 → 정확한 PnL 기록
     │
     └─→ ACCOUNT_UPDATE 이벤트 (백업)
            └─→ 5초 내 미처리 → 동기화
```

### 2.5 Algo Order 처리 (중요)

Binance Algo Order API를 사용할 때 주의사항:

| 항목 | 설명 |
|------|------|
| **주문 타입** | STOP, TAKE_PROFIT (Algo Order API) |
| **트리거 시** | LIMIT 주문으로 변환됨 (STOP_MARKET 아님) |
| **식별 방법** | `reduceOnly=true` (order.R === true) |
| **매칭 방식** | 주문 ID 매칭 실패 시 가격 기반 매칭 (0.5% tolerance) |

```
[Algo Order 생성]
     │
     ├─→ /fapi/v1/algoOrder (type: STOP/TAKE_PROFIT)
     │
     └─→ 트리거 가격 도달 시
            │
            ├─→ LIMIT 주문 생성 (새 주문 ID)
            │      └─→ reduceOnly: true
            │
            └─→ ORDER_TRADE_UPDATE 콜백
                   └─→ orderType: LIMIT, reduceOnly: true
```

### 2.6 PnL 계산 방식

| 방식 | 설명 |
|------|------|
| **권장** | Binance `realizedProfit` (order.rp) 직접 사용 |
| **특징** | 수수료, 레버리지 이미 반영됨 |
| **Fallback** | (exitPrice - entryPrice) × quantity (레버리지 미반영) |

```typescript
// 올바른 방식: Binance realizedProfit 사용
const pnlUsd = parseFloat(order.rp);  // 바이낸스 실현 손익 직접 사용

// 이전 잘못된 방식 (사용 금지)
// const pnlUsd = (exitPrice - entryPrice) * quantity * leverage;  // ❌ 중복 계산
```

---

## 3. Strategy A: CycleRider

### 3.1 포지션 설정
| 항목 | 값 | 설명 |
|------|-----|------|
| 레버리지 | **15x** | 소액 시드, 추세 확인 시 비중 확대 |
| 마진 | **$50** | 건당 마진 |
| 최대 포지션 | **5개** | 동시 보유 |
| 같은 방향 최대 | **3개** | 방향별 제한 |
| 최소 보유 | **30분** | |
| 최대 보유 | **240분 (4시간)** | |
| TP1 청산 비율 | **25%** | 추세 수익 보존 |
| 쿨다운 | **30분** | 손절 후 재진입 대기 |

### 3.2 트레일링 스탑
| 항목 | 값 |
|------|-----|
| 활성화 | TP1 체결 후 |
| 거리 | **2.5 ATR** |
| 스텝 | **0.3 ATR** |

### 3.3 ATR 필터
| 항목 | 값 |
|------|-----|
| 최소 ATR | **0.45%** |
| 최대 ATR | **3.0%** |

### 3.4 Regime RSI 필터
| 시장 상태 | LONG 조건 | SHORT 조건 |
|----------|----------|-----------|
| STRONG_DOWNTREND | RSI ≤ 20 | - |
| WEAK_DOWNTREND | RSI ≤ 30 | - |
| WEAK_UPTREND | - | RSI ≥ 70 |
| STRONG_UPTREND | - | RSI ≥ 80 |

### 3.5 Sub-Strategy: Volume Climax
| 항목 | 값 | 설명 |
|------|-----|------|
| 볼륨 평균 기간 | 20봉 | |
| **최소 볼륨 배수** | **2.0x** | 진입 기회 확대 + 노이즈 필터 균형 |
| **최소 캔들 크기** | **1.4 ATR** | |
| RSI 기간 | 14 | |
| **매수 클라이맥스 RSI** | **≥ 75** | 양봉 + RSI 75 이상 → SHORT |
| **매도 클라이맥스 RSI** | **≤ 25** | 음봉 + RSI 25 이하 → LONG |
| 진입 지연 | 2봉 | 반전 확인 |
| 추세 소진 확인 | 필수 | 최소 5봉 추세 |
| SL | 1.0 ATR | |
| TP1 | 1.5 R:R | |
| TP2 | **4.0 R:R** | 크게 먹는 구간에서 끝까지 홀딩 |

### 3.6 Sub-Strategy: Squeeze
| 항목 | 값 |
|------|-----|
| BB 기간 | 20 |
| BB 표준편차 | 2.0 |
| KC 기간 | 20 |
| KC ATR 배수 | 1.5 |
| **최소 스퀴즈 봉** | **6봉** |
| 모멘텀 기간 | 12 |
| 최소 모멘텀 강도 | 30 |
| **최소 ADX** | **18** | 추세 형성 초기 단계에서 진입 |
| 최소 RVol | 1.5x |
| SL | 1.0 ATR |
| TP1 | 2.0 ATR |
| TP2 | 3.0 ATR |

---

## 4. Strategy B: HourSwing

### 4.1 포지션 설정
| 항목 | 값 |
|------|-----|
| 레버리지 | **12x** |
| 마진 | **$30** |
| 최대 포지션 | **5개** |
| 같은 방향 최대 | **3개** |
| 최소 보유 | **15분** |
| 최대 보유 | **60분** |
| TP1 청산 비율 | **50%** |
| 쿨다운 | **10분** |

### 4.2 ATR 필터
| 항목 | 값 |
|------|-----|
| 최소 ATR | **0.5%** |
| 최대 ATR | **3.5%** |

### 4.3 동시 진입 제한
| 항목 | 값 |
|------|-----|
| 최대 동시 진입 | 2개 |
| 윈도우 | 5분 |

### 4.4 Sub-Strategy: MTF Alignment
| 타임프레임 | 항목 | 값 |
|-----------|------|-----|
| **1H** | 추세 봉 | 6봉 |
| | 최소 강도 | 0.07 |
| | 최대 강도 | 0.5 |
| | **최대 연속 봉** | **3봉** (늦은 진입 방지) |
| **15M** | 추세 봉 | 4봉 |
| | 최소 강도 | 0.2 |
| | 1H 정렬 필수 | Yes |
| **5M** | 풀백 봉 | 3봉 |
| | 풀백 깊이 | 0.5 ~ 1.2 ATR |
| **RSI 필터** | LONG 금지 | RSI > 65 |
| | SHORT 금지 | RSI < 35 |
| **SL/TP** | SL | 1.0 ATR (0.6%~1.5%) |
| | TP1 | 1.2 R:R |
| | TP2 | 1.8 R:R |

### 4.5 Sub-Strategy: Funding Extremes
| 항목 | 값 | 설명 |
|------|-----|------|
| 펀딩 히스토리 | 168시간 (7일) | |
| **극단 Z-Score** | **2.0** | 표준편차 |
| **극단 절대값 (HIGH)** | **+0.05%** | 펀딩비가 조금만 치우쳐도 반전 기회 포착 |
| **극단 절대값 (LOW)** | **-0.05%** | |
| **반전 구간** | **저점의 103%** (LONG) | 가격 조건 (최적화: 102% → 103% 보수적 완화) |
| | **고점의 98%** (SHORT) | |
| 모멘텀 둔화 봉 | **2봉** | |
| RSI 과매수 | 70 | |
| RSI 과매도 | 30 | |
| 확인 필수 | Yes | RSI 극단 확인 |
| SL | 1.0 ATR | |
| TP1 | 1.8 R:R | |
| TP2 | 2.5 R:R | |

---

## 5. Strategy C: BoxRange

### 5.1 포지션 설정
| 항목 | 값 |
|------|-----|
| 기본 레버리지 | **15x** (등급별 조정) |
| 마진 | **$30** |
| 최대 포지션 | **4개** |
| 같은 방향 최대 | **1개** |
| 쿨다운 | **15분** |

### 5.2 Box 정의 조건

#### 스윙 포인트
| 항목 | 값 |
|------|-----|
| ZigZag Depth | 5봉 |
| 최소 Swing High | 2개 |
| 최소 Swing Low | 2개 |
| 최대 편차 | 2.0 ATR |

#### Box 높이 (ATR 기준)
| 항목 | 값 |
|------|-----|
| 최소 | **2.0 ATR** |
| 최대 | **4.5 ATR** |
| 최적 범위 | 2.0 ~ 4.0 ATR |

#### Box 나이
| 항목 | 값 |
|------|-----|
| **최소** | **20봉 (5시간)** |
| 경고 | 48봉 (12시간) |
| 최대 | 72봉 (18시간) |
| 만료 | 96봉 (24시간) |

#### ADX 조건
| 항목 | 값 |
|------|-----|
| **최대 ADX** | **28** | 완벽한 횡보가 아니더라도 박스권이면 진입 |
| 최대 DI 차이 | 10 |

#### 볼륨 프로파일
| 항목 | 값 |
|------|-----|
| 중심 볼륨 비율 | **77.5%** |
| Edge 볼륨 배수 | 1.2x |

### 5.3 진입 조건

#### 진입 구간
| 항목 | 값 |
|------|-----|
| **진입 구간** | **상/하단 20%** (최적화: 15% → 20% 진입 기회 확대) |

#### Long 진입
| 항목 | 값 |
|------|-----|
| RSI | < 35 |
| 양봉 필수 | Yes |
| 최대 이탈 | 0.2% |

#### Short 진입
| 항목 | 값 |
|------|-----|
| RSI | > 65 |
| 음봉 필수 | Yes |
| 최대 이탈 | 0.2% |

#### 필터
| 필터 | 값 | 설명 |
|------|-----|------|
| **볼륨 감소** | **< 70%** | 평균 대비 (브레이크아웃 방지) |
| RSI 기울기 | < 30pt | 3봉 내 변화 |
| 연속 봉 제한 | 2봉 | 같은 방향 |

### 5.4 SL/TP
| 항목 | 값 |
|------|-----|
| **SL 버퍼** | **0.5 ATR** | 휩소에 의한 잦은 손절 방지 |
| TP1 | POC 또는 Box 50% |
| TP1 청산 | **70%** |
| TP2 | Box 90% |
| TP2 청산 | 30% |
| TP1 후 SL | 본전 + 0.1% |

### 5.5 Box 등급 시스템
| 등급 | 최소 신뢰도 | 레버리지 | 사이즈 |
|------|-----------|---------|-------|
| **A** | 85점 | 15x | 100% |
| **B** | 70점 | 12x | 75% |
| **C** | 60점 | 9x | 50% |
| 미달 | <60점 | 진입 거부 | - |

### 5.6 시간 필터
| 항목 | 값 |
|------|-----|
| 진입 금지 | **22:00 ~ 00:30 KST** |
| (미 증시 초반 변동성만 피하고 기회 확보) | |

---

## 6. 공통 필터

### 6.1 ATR 필터 요약
| 전략 | 최소 ATR | 최대 ATR |
|------|---------|---------|
| CycleRider | 0.45% | 3.0% |
| HourSwing | 0.5% | 3.5% |
| BoxRange | 0.2% | 3.5% |

### 6.2 기타 공통 필터
| 항목 | 값 |
|------|-----|
| 최대 스프레드 | 0.07% |
| 최소 볼륨 랭크 | Top 70% |
| 최소 유동성 | $1M 일일 거래량 |

---

## 7. 리스크 관리

### 7.1 일일 손실 한도
| 항목 | 값 |
|------|-----|
| 일일 최대 손실 | (설정에 따름) |
| 손실 도달 시 | 당일 매매 중단 |

### 7.2 포지션 한도
| 전략 | 최대 포지션 | 같은 방향 |
|------|-----------|----------|
| CycleRider | 5개 | 3개 |
| HourSwing | 5개 | 3개 |
| BoxRange | 4개 | 1개 |

### 7.3 SL/TP 주문 추적
- 모든 SL/TP 주문 ID를 Position에 저장
- 체결 시 주문 ID 매칭으로 정확한 close_reason 기록
- **Algo Order 트리거 시**: LIMIT 주문으로 변환 (새 주문 ID)
  - `reduceOnly=true` 플래그로 청산 주문 식별
  - 가격 기반 매칭 (0.5% tolerance) 으로 SL/TP 구분
- 매칭 실패 시 order type으로 fallback

---

## 부록: 설정 파일 위치

```
/backend/src/dual-strategy/constants/
├── cycle-rider.config.ts    # CycleRider 전략
├── hour-swing.config.ts     # HourSwing 전략
├── box-range.config.ts      # BoxRange 전략
└── common.config.ts         # 공통 설정
```

---

*이 문서는 실제 코드의 Config 파일에서 추출한 값입니다.*
